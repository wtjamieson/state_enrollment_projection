---
title: 'State Level Enrollment Projections'
output:
  html_document:
    theme: cerulean
    highlight: pygments
    css: lab.css
  pdf_document: default
---

```{r global-options, include=FALSE}
#knitr::opts_chunk$set(eval = FALSE)
library(tidyverse)
library(tidymodels)
library(skimr)

setwd("/Users/williamjamieson/Desktop/Data Science/Reaching Higher NH") 
```

#### William T. Jamieson

The purpose of this document is to develop a model which predicts future public K-12 enrollments in the state of New Hampshire.

# Data collection and cleaning

All data referenced in this document was sourced from the New Hampshire Department of Education (https://www.education.nh.gov/who-we-are/division-of-educator-and-analytic-resources/bureau-of-education-statistics/enrollments-by-grade). These datasets consist of Oct. 1st enrollments aggregated by grade and school between the 2007-2008 and 2020-2021 school years. I restricted the datasets to public school systems (excluding public academies, joint maintenance agreements, and public charter schools). I also excluded preschool, readiness, or post-graduate enrollments.

I mentioned previously that it appears as though kindergarten enrollments have been flat over the past decade or so, which would bode well for enrollment numbers in the state to eventually stabilize. However, when the data is aggregated by grade level, you can see that the correlation between kindergarten and 1st grade enrollments is not as strong as I would have expected- the kindergarten enrollments are (roughly) flat, but 1st grade enrollments have dropped over the same timespan, before stabilizing during the 2016-2019 school years. It would be interesting to try to understand why kindergarten and 1st grade enrollments are less correlated than other sequential grades- is it the case that many school districts were/are not offering kindergarten to their students? Is there a different explanation?

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, out.width = "50%"}
enroll <- readr::read_csv("historical_enrollments_by_district.csv")

statewide_totals_by_grade <- enroll %>%
  group_by(year) %>%
  mutate(`12` = sum(`12`,na.rm = TRUE),
         `11` = sum(`11`,na.rm = TRUE),
         `10` = sum(`10`,na.rm = TRUE),
         `9` = sum(`9`,na.rm = TRUE),
         `8` = sum(`8`,na.rm = TRUE),
         `7` = sum(`7`,na.rm = TRUE),
         `6` = sum(`6`,na.rm = TRUE),
         `5` = sum(`5`,na.rm = TRUE),
         `4` = sum(`4`,na.rm = TRUE),
         `3` = sum(`3`,na.rm = TRUE),
         `2` = sum(`2`,na.rm = TRUE),
         `1` = sum(`1`,na.rm = TRUE),
         `0` = sum(`0`,na.rm = TRUE),
         total = sum(total,na.rm = TRUE)) %>%
  select(-dist_name,-min_grade,-max_grade) %>%
  distinct() %>%
  pivot_longer(cols = `0`:`12`, names_to = "grade", values_to = "enrollment")

statewide_totals_by_grade %>%
  filter(grade %in% c(0,1,2,3,4)) %>%
  ggplot(aes(year,enrollment, color = grade)) +
  geom_line() +
  geom_point() +
  scale_color_discrete(name = "Grade", labels = c("K", "1st","2nd","3rd","4th")) +
  ylim(0,16500) +
  labs(x = NULL, y = "Statewide Enrollment") + 
  ggtitle("Elementary School Enrollments, 2007 - 2020")

statewide_totals_by_grade %>%
  filter(grade %in% c(5,6,7,8)) %>%
  ggplot(aes(year,enrollment, color = grade)) +
  geom_line() +
  geom_point() +
  scale_color_discrete(name = "Grade", labels = c("5th","6th","7th","8th")) +
  ylim(0,16500) +
  labs(x = NULL, y = "Statewide Enrollment") + 
  ggtitle("Middle School Enrollments, 2007 - 2020")

statewide_totals_by_grade %>%
  filter(grade %in% c(9,10,11,12)) %>%
  ggplot(aes(year,enrollment, color = grade)) +
  geom_line() +
  geom_point() +
  scale_color_discrete(name = "Grade", labels = c("9th","10th","11th","12th")) +
  ylim(0,16500) +
  labs(x = NULL, y = "Statewide Enrollment") + 
  ggtitle("High School Enrollments, 2007 - 2020")

```


Further, I accessed NHVRIN web to collect historical data about the number of children being born to mothers who are New Hampshire residents. This dataset counts the number of births regardless of the number of children who are born at once. To correct this, I aggregated the dataset by plurality (number of children born during the birth event) and multiplied the number of births of each plurality by the plurality. The resulting dataset counts the number of children born, aggregated by the mother's town or city of residence. 

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, out.width = "50%", fig.align = "center"}
readr::read_csv("nh_births_by_town.csv") %>%
  pivot_longer(cols = births_1995:births_2021, names_to = c("year"), names_pattern = "births_(.*)", values_to = "births") %>%
  filter(!Plurality %in% c("Subtotal:","Unknown","Total:","7 or more"), year != "2021") %>%
  mutate(Plurality = as.numeric(Plurality),
         births = as.numeric(gsub("--","0",births)),
         num_babies = Plurality*births,
         year = as.numeric(year)) %>%
  group_by(`Mother Residence City`,year) %>%
  mutate(total_babies = sum(num_babies)) %>%
  ungroup() %>%
  select(`Mother Residence City`,year,total_babies) %>%
  distinct() %>%
  group_by(year) %>%
  mutate(total_babies = sum(total_babies)) %>%
  ungroup() %>%
  select(year,total_babies) %>%
  distinct() %>%
  ggplot(aes(year,total_babies)) +
  geom_line() + 
  geom_point() +
  labs(x = NULL, y = "Statewide Live Births") +
  expand_limits(y=0) + 
  ggtitle("Number of Live Births with State Resident Mothers")
```

# Model Construction

In the model, I made the assumption that the number of children born to mothers who reside in a particular school district (or in the state of New Hampshire) is a strong predictor of kindergarten enrollment five years later. To estimate future enrollments, we assume that all seniors graduate, all existing students rise to the next grade level, and the number of kindergartners is estimated by the number of children born in the area five years earlier. These assumptions ignore several important factors, such as immigration and emigration, students who disenroll from a school system for various reasons (home schooling, private/charter schools, drop outs, etc.), and children whose parent(s) move before the child enters the public school system. To account for these factors, I built a linear regression model which predicts the error in the estimate described above, measured by $\text{Error in Estimate} =  \frac{\text{estimate}-\text{actual enrollment}}{\text{estimate}}$. The predictor variables are the year the estimate is being made and the number of years into the future that the enrollment is being estimated, both measured as numerical variables.

```{r echo = FALSE, eval = TRUE, message = FALSE}
births <- readr::read_csv("nh_births_by_town.csv")

births <- births %>%
  pivot_longer(cols = births_1995:births_2021, names_to = c("year"), names_pattern = "births_(.*)", values_to = "births") %>%
  filter(!Plurality %in% c("Subtotal:","Unknown","Total:","7 or more"), year != "2021") %>%
  mutate(Plurality = as.numeric(Plurality),
         births = as.numeric(gsub("--","0",births)),
         num_babies = Plurality*births,
         year = as.numeric(year)) %>%
  group_by(`Mother Residence City`,year) %>%
  mutate(total_babies = sum(num_babies)) %>%
  ungroup() %>%
  select(`Mother Residence City`,year,total_babies) %>%
  distinct() %>%
  rename(town = `Mother Residence City`) %>%
  mutate(town = gsub(", Town of","",town)) %>%
  group_by(town) %>%
  mutate(total_babies_5_year = lag(total_babies,5),
         total_babies_4_year = lag(total_babies,4),
         total_babies_3_year = lag(total_babies,3),
         total_babies_2_year = lag(total_babies,2),
         total_babies_1_year = lag(total_babies,1)) %>%
  ungroup() %>%
  select(town,year,total_babies_5_year,total_babies_4_year,total_babies_3_year,total_babies_2_year,total_babies_1_year) %>%
  filter(!is.na(total_babies_5_year))
```

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
enroll <- readr::read_csv("historical_enrollments_by_district.csv")

statewide_totals <- enroll %>%
  group_by(year) %>%
  mutate(`12` = sum(`12`,na.rm = TRUE),
         `11` = sum(`11`,na.rm = TRUE),
         `10` = sum(`10`,na.rm = TRUE),
         `9` = sum(`9`,na.rm = TRUE),
         `8` = sum(`8`,na.rm = TRUE),
         `7` = sum(`7`,na.rm = TRUE),
         `6` = sum(`6`,na.rm = TRUE),
         `5` = sum(`5`,na.rm = TRUE),
         `4` = sum(`4`,na.rm = TRUE),
         `3` = sum(`3`,na.rm = TRUE),
         `2` = sum(`2`,na.rm = TRUE),
         `1` = sum(`1`,na.rm = TRUE),
         `0` = sum(`0`,na.rm = TRUE),
         total = sum(total,na.rm = TRUE)) %>%
  select(-dist_name,-min_grade,-max_grade) %>%
  distinct() %>%
  select(year,total) %>%
  ungroup() %>%
  mutate(total_per_change = (total-lead(total))/lead(total))

statewide_df <- enroll %>%
  group_by(year) %>%
  mutate(`12` = sum(`12`,na.rm = TRUE),
         `11` = sum(`11`,na.rm = TRUE),
         `10` = sum(`10`,na.rm = TRUE),
         `9` = sum(`9`,na.rm = TRUE),
         `8` = sum(`8`,na.rm = TRUE),
         `7` = sum(`7`,na.rm = TRUE),
         `6` = sum(`6`,na.rm = TRUE),
         `5` = sum(`5`,na.rm = TRUE),
         `4` = sum(`4`,na.rm = TRUE),
         `3` = sum(`3`,na.rm = TRUE),
         `2` = sum(`2`,na.rm = TRUE),
         `1` = sum(`1`,na.rm = TRUE),
         `0` = sum(`0`,na.rm = TRUE),
         total = sum(total,na.rm = TRUE)) %>%
  select(-dist_name,-min_grade,-max_grade) %>%
  distinct() %>%
  filter(year != 2020) %>%
  left_join(births %>%
              group_by(year) %>%
              mutate(total_babies_5_year = sum(total_babies_5_year),
                     total_babies_4_year = sum(total_babies_4_year),
                     total_babies_3_year = sum(total_babies_3_year),
                     total_babies_2_year = sum(total_babies_2_year),
                     total_babies_1_year = sum(total_babies_1_year)) %>%
              select(-town) %>%
              distinct(),
            by = "year") %>%
  mutate(est_1_year = total - `12` + total_babies_4_year,
         est_2_year = est_1_year - `11` + total_babies_3_year,
         est_3_year = est_2_year - `10` + total_babies_2_year,
         est_4_year = est_3_year - `9` + total_babies_1_year) %>%
  pivot_longer(cols = est_1_year:est_4_year, names_to = "years_out", names_pattern = "est_(.)_year", values_to = "estimate") %>%
  mutate(estimate_year = year + as.numeric(years_out)) %>%
  select(year, estimate_year, years_out, estimate) %>%
  left_join(enroll %>%
              group_by(year) %>%
              mutate(`12` = sum(`12`,na.rm = TRUE),
                     `11` = sum(`11`,na.rm = TRUE),
                     `10` = sum(`10`,na.rm = TRUE),
                     `9` = sum(`9`,na.rm = TRUE),
                     `8` = sum(`8`,na.rm = TRUE),
                     `7` = sum(`7`,na.rm = TRUE),
                     `6` = sum(`6`,na.rm = TRUE),
                     `5` = sum(`5`,na.rm = TRUE),
                     `4` = sum(`4`,na.rm = TRUE),
                     `3` = sum(`3`,na.rm = TRUE),
                     `2` = sum(`2`,na.rm = TRUE),
                     `1` = sum(`1`,na.rm = TRUE),
                     `0` = sum(`0`,na.rm = TRUE),
                     total = sum(total,na.rm = TRUE)) %>%
              select(year,total) %>%
              distinct() %>%
              filter(year != 2020),
            by = c("estimate_year" = "year")) %>%
  group_by(year) %>%
  mutate(per_error = (estimate-total)/estimate) %>%
  ungroup() %>%
  left_join(statewide_totals %>%
              select(year,total_per_change), by = "year")
```

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, fig.align='center'}
statewide_df %>%
  ggplot(aes(estimate, total, color = as.factor(years_out))) + 
  geom_point() + 
  geom_abline() + 
  labs(x = "Estimated State K-12 Enrollment", y = "Actual State K-12 Enrollment", color = "Years into the Future")
```

The scatter plot above shows that the method of estimation has consistently overestimated the state enrollment numbers, and that the amount of overestimation increases as the model projects further into the future. 

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, fig.align='center'}
statewide_df %>%
  ggplot(aes(year, per_error, color = as.factor(years_out))) + 
  geom_line(stat = "smooth", formula = "y ~ poly(x,1)", method = "lm", alpha = 0.5, size = 1) + 
  geom_point() + 
  scale_y_continuous(labels = scales::percent) +
  expand_limits(y = 0) + 
  labs(x = "Year", y = "Error in Estimation", color = "Years into the Future")
```

From the scatter plot of the estimation error against the year, we see that the error rate was highest in 2009-2011 (potentially related to the great recession?) and that the percentage error in the estimations have been improving since that point in time. It is tempting to use a higher-order model to capture the nonlinear relationship between the year and the percentage error, but we will be extrapolating which would cause a flexible model to be overly optimistic about the magnitude of the error. 

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, fig.align='center'}
statewide_df %>%
  ggplot(aes(years_out, per_error)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = scales::percent) + 
  expand_limits(y = 0) + 
  labs(x = "Years into the Future", y = "Error in Estimation", color = "Years into the Future")
```

Our simplistic estimations of enrollment become less predictive as the number of years being projected into the future increases, which is not surprising, since they are based on less current information. The hypothesized form of the model is

$$
\text{% Error in Estimation} = \beta_0 + \beta_1 \cdot \text{Number of Years Projecting Forward} + \beta_2 \cdot \text{Year}.
$$

When I trained the model, I removed datapoints corresponding to the 2020 school year, since these enrollment numbers where depressed by the COVID-19 pandemic, which (hopefully) will not be continuing in perpetuity. Although the model fit can be improved by using a more flexible model, concerns about the small sample size and the presence of auto-correlation prompted me to choose a relatively inflexible model. 

## Results

Model diagnostics for the fitted model are given below:

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
lm_spec <- linear_reg() %>%
  set_engine("lm")

lm_state <- lm_spec %>%
  fit(per_error ~  years_out + year, data = statewide_df %>% mutate(years_out = as.numeric(years_out)))

lm_state %>%
  tidy()

lm_state %>%
  glance()
```


```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, fig.align = 'center'}
statewide_df_2019_5_year <- enroll %>%
  group_by(year) %>%
  mutate(`12` = sum(`12`,na.rm = TRUE),
         `11` = sum(`11`,na.rm = TRUE),
         `10` = sum(`10`,na.rm = TRUE),
         `9` = sum(`9`,na.rm = TRUE),
         `8` = sum(`8`,na.rm = TRUE),
         `7` = sum(`7`,na.rm = TRUE),
         `6` = sum(`6`,na.rm = TRUE),
         `5` = sum(`5`,na.rm = TRUE),
         `4` = sum(`4`,na.rm = TRUE),
         `3` = sum(`3`,na.rm = TRUE),
         `2` = sum(`2`,na.rm = TRUE),
         `1` = sum(`1`,na.rm = TRUE),
         `0` = sum(`0`,na.rm = TRUE),
         total = sum(total,na.rm = TRUE)) %>%
  select(-dist_name,-min_grade,-max_grade) %>%
  distinct() %>%
  ungroup() %>%
  filter(year == 2019) %>%
  cbind(births %>%
          group_by(year) %>%
          mutate(total_babies_5_year = sum(total_babies_5_year),
                 total_babies_4_year = sum(total_babies_4_year),
                 total_babies_3_year = sum(total_babies_3_year),
                 total_babies_2_year = sum(total_babies_2_year),
                 total_babies_1_year = sum(total_babies_1_year)) %>%
          select(-town) %>%
          distinct() %>%
          ungroup() %>%
          filter(year == 2020) %>%
          select(-year)) %>%
  mutate(est_1_year = total - `12` + total_babies_5_year,
         est_2_year = est_1_year - `11` + total_babies_4_year,
         est_3_year = est_2_year - `10` + total_babies_3_year,
         est_4_year = est_3_year - `9` + total_babies_2_year,
         est_5_year = est_3_year - `8` + total_babies_1_year) %>%
  pivot_longer(cols = est_1_year:est_5_year, names_to = "years_out", names_pattern = "est_(.)_year", values_to = "estimate") %>%
  mutate(estimate_year = year + as.numeric(years_out)) %>%
  select(year, estimate_year, years_out, estimate) %>%
  mutate(years_out = as.numeric(years_out)) %>%
  left_join(statewide_totals %>%
              select(year,total_per_change), by = "year")

statewide_df_2020 <- enroll %>%
  group_by(year) %>%
  mutate(`12` = sum(`12`,na.rm = TRUE),
         `11` = sum(`11`,na.rm = TRUE),
         `10` = sum(`10`,na.rm = TRUE),
         `9` = sum(`9`,na.rm = TRUE),
         `8` = sum(`8`,na.rm = TRUE),
         `7` = sum(`7`,na.rm = TRUE),
         `6` = sum(`6`,na.rm = TRUE),
         `5` = sum(`5`,na.rm = TRUE),
         `4` = sum(`4`,na.rm = TRUE),
         `3` = sum(`3`,na.rm = TRUE),
         `2` = sum(`2`,na.rm = TRUE),
         `1` = sum(`1`,na.rm = TRUE),
         `0` = sum(`0`,na.rm = TRUE),
         total = sum(total,na.rm = TRUE)) %>%
  select(-dist_name,-min_grade,-max_grade) %>%
  distinct() %>%
  left_join(births %>%
              group_by(year) %>%
              mutate(total_babies_5_year = sum(total_babies_5_year),
                     total_babies_4_year = sum(total_babies_4_year),
                     total_babies_3_year = sum(total_babies_3_year),
                     total_babies_2_year = sum(total_babies_2_year),
                     total_babies_1_year = sum(total_babies_1_year)) %>%
              select(-town) %>%
              distinct(),
            by = "year") %>%
  mutate(est_1_year = total - `12` + total_babies_4_year,
         est_2_year = est_1_year - `11` + total_babies_3_year,
         est_3_year = est_2_year - `10` + total_babies_2_year,
         est_4_year = est_3_year - `9` + total_babies_1_year) %>%
  pivot_longer(cols = est_1_year:est_4_year, names_to = "years_out", names_pattern = "est_(.)_year", values_to = "estimate") %>%
  mutate(estimate_year = year + as.numeric(years_out)) %>%
  select(year, estimate_year, years_out, estimate) %>%
  left_join(enroll %>%
              group_by(year) %>%
              mutate(`12` = sum(`12`,na.rm = TRUE),
                     `11` = sum(`11`,na.rm = TRUE),
                     `10` = sum(`10`,na.rm = TRUE),
                     `9` = sum(`9`,na.rm = TRUE),
                     `8` = sum(`8`,na.rm = TRUE),
                     `7` = sum(`7`,na.rm = TRUE),
                     `6` = sum(`6`,na.rm = TRUE),
                     `5` = sum(`5`,na.rm = TRUE),
                     `4` = sum(`4`,na.rm = TRUE),
                     `3` = sum(`3`,na.rm = TRUE),
                     `2` = sum(`2`,na.rm = TRUE),
                     `1` = sum(`1`,na.rm = TRUE),
                     `0` = sum(`0`,na.rm = TRUE),
                     total = sum(total,na.rm = TRUE)) %>%
              select(year,total) %>%
              distinct(),
            by = c("estimate_year" = "year")) %>%
  group_by(year) %>%
  mutate(res = total - estimate) %>%
  ungroup() %>%
  filter(year == 2020) %>%
  mutate(years_out = as.numeric(years_out)) %>%
  left_join(statewide_totals %>%
              select(year,total_per_change), by = "year")

pandemic_est <- lm_state %>%
  predict(new_data = statewide_df_2020) %>%
  mutate(year = 2021:2024,
         estimate = statewide_df_2020 %>% select(estimate) %>% pull(),
         model_estimate = estimate - (.pred * estimate))

nonpandemic_est <- lm_state %>%
  predict(new_data = statewide_df_2019_5_year) %>%
  mutate(year = 2020:2024,
         estimate = statewide_df_2019_5_year %>% select(estimate) %>% pull(),
         model_estimate = estimate - (.pred * estimate))

statewide_df_2020_bounds <- lm_state %>%
  predict(new_data = statewide_df_2020, type = "pred_int") %>%
  bind_cols(statewide_df_2020 %>%
                select(year,estimate_year,years_out,estimate)) %>%
  mutate(enroll_est_upper = -estimate*.pred_lower + estimate,
         enroll_est_lower = -estimate*.pred_upper + estimate)

statewide_df_2019_5_year_bounds <- lm_state %>%
  predict(new_data = statewide_df_2019_5_year, type = "pred_int") %>%
  bind_cols(statewide_df_2019_5_year %>%
                select(year,estimate_year,years_out,estimate)) %>%
  mutate(enroll_est_upper = -estimate*.pred_lower + estimate,
         enroll_est_lower = -estimate*.pred_upper + estimate)
```

I used the model to make enrollment projections in two scenarios. First, I projected 5 years into the future, starting from 2019 and excluding the enrollment numbers from 2020. This projection assumes that the COVID-19 pandemic did not cause any public school disenrollments and provides a reasonable upper bound for the enrollment projections. Second, I projected 4 years into the future starting from 2020. This projection assumes that none of the students who disenrolled from public schools will reenroll, and thus provides a reasonable lower bound for the enrollment projections. In reality, we would expect the enrollments to fall between these two extremes. The table below provides the estimates for each of the projections up to 2024, along with the 95% prediction intervals for these projections.

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, fig.align = 'center'}
library(kableExtra)

pandemic_est %>%
  cbind(statewide_df_2020_bounds %>% 
          select(enroll_est_upper,enroll_est_lower)) %>%
  select(year,enroll_est_lower,model_estimate, enroll_est_upper) %>%
  mutate(model_estimate = round(model_estimate),
         enroll_est_lower = round(enroll_est_lower),
         enroll_est_upper = round(enroll_est_upper),
         ) %>%
  rename(Year = year, "Model Estimate" = model_estimate, "Model Estimate Lower Bound" = enroll_est_lower, "Model Estimate Upper Bound" = enroll_est_upper) %>% 
  knitr::kable(caption = "Projected Enrollments Assuming No Pandemic Disenrollments Return",
               table.attr = "style='width:80%;'")

nonpandemic_est %>%
  cbind(statewide_df_2019_5_year_bounds %>% 
          select(enroll_est_upper,enroll_est_lower)) %>%
  select(year,enroll_est_lower,model_estimate, enroll_est_upper) %>%
  mutate(model_estimate = round(model_estimate),
         enroll_est_lower = round(enroll_est_lower),
         enroll_est_upper = round(enroll_est_upper),
         ) %>%
  rename(Year = year, "Model Estimate" = model_estimate, "Model Estimate Lower Bound" = enroll_est_lower, "Model Estimate Upper Bound" = enroll_est_upper) %>% 
  knitr::kable(caption = "Projected Enrollments Assuming All Pandemic Disenrollments Return",
               table.attr = "style='width:80%;'")

```

<br>
The difference between the two models is roughly 5,000 students. On the left, we see the historical enrollment numbers, and on the right we see the same graphic, but zoomed in on the area where the projections are being made.

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, out.width = "50%"}

ggplot() +
  geom_line(data = statewide_totals, aes(year,total), color = 'blue') + 
  geom_line(data = pandemic_est %>%
              select(year, model_estimate) %>%
              rbind(statewide_totals %>% filter(year == 2020) %>% rename(model_estimate = total)  %>% select(year, model_estimate)), aes(year,model_estimate), color = 'red')  + 
  geom_point(data = pandemic_est, aes(year,model_estimate), color = 'red') +
  geom_line(data = nonpandemic_est %>%
              select(year, model_estimate) %>%
              rbind(statewide_totals %>% filter(year == 2019) %>% rename(model_estimate = total) %>% select(year, model_estimate)), aes(year,model_estimate), color = 'forestgreen') + 
  geom_point(data = nonpandemic_est, aes(year,model_estimate), color = 'forestgreen') +
  geom_point(data = statewide_totals, aes(year,total), color = 'blue') + 
  geom_line(data = statewide_df_2020_bounds, aes(estimate_year,enroll_est_upper), linetype = "dashed", color = 'red') + 
  geom_line(data = statewide_df_2020_bounds, aes(estimate_year,enroll_est_lower), linetype = "dashed", color = 'red') +
  geom_line(data = statewide_df_2019_5_year_bounds, aes(estimate_year,enroll_est_upper), linetype = "dashed", color = 'forestgreen') + 
  geom_line(data = statewide_df_2019_5_year_bounds, aes(estimate_year,enroll_est_lower), linetype = "dashed", color = 'forestgreen') +
  expand_limits(y = 0) + 
  labs(x = NULL, y = "Statewide Public K-12 Enrollment") 

ggplot() +
  geom_line(data = statewide_totals, aes(year,total, color = 'blue')) + 
  geom_line(data = pandemic_est %>%
              select(year, model_estimate) %>%
              rbind(statewide_totals %>% filter(year == 2020) %>% rename(model_estimate = total)  %>% select(year, model_estimate)), aes(year,model_estimate, color = 'red'))  + 
  geom_point(data = pandemic_est, aes(year,model_estimate, color = 'red')) +
  geom_line(data = nonpandemic_est %>%
              select(year, model_estimate) %>%
              rbind(statewide_totals %>% filter(year == 2019) %>% rename(model_estimate = total) %>% select(year, model_estimate)), aes(year,model_estimate, color = 'forestgreen')) + 
  geom_point(data = nonpandemic_est, aes(year,model_estimate, color = 'forestgreen')) +
  geom_point(data = statewide_totals, aes(year,total, color = 'blue')) + 
  geom_line(data = statewide_df_2020_bounds, aes(estimate_year,enroll_est_upper), linetype = "dashed", color = 'red') + 
  geom_line(data = statewide_df_2020_bounds, aes(estimate_year,enroll_est_lower), linetype = "dashed", color = 'red') +
  geom_line(data = statewide_df_2019_5_year_bounds, aes(estimate_year,enroll_est_upper), linetype = "dashed", color = 'forestgreen') + 
  geom_line(data = statewide_df_2019_5_year_bounds, aes(estimate_year,enroll_est_lower), linetype = "dashed", color = 'forestgreen') +
  xlim(2019,2024) +
  ylim(145000,165000) + 
  labs(x = NULL , y = "Statewide Public K-12 Enrollment") + 
  scale_color_manual(name = '', 
                     values = c('blue' = 'blue','red'='red', 'forestgreen' = 'forestgreen'), 
                     labels = c('Actual Enrollment','Upper Bound Projection','Lower Bound Projection')
                     ) 
```

I don't feel comfortable making projections further than 4 years into the future, since many members of the kindergarten class five years from now have not been born yet, and thus would require projecting the number of children that will be born in the state. The COVID-19 pandemic has had a drastic effect on fertility rates, so there would be a large amount of uncertainly in those estimates.



```{r echo = FALSE, eval = FALSE, message = FALSE, warning = FALSE, out.width = "50%"}
results <- lm_state %>%
  predict(new_data = statewide_df %>% mutate(years_out = as.numeric(years_out))) %>%
  bind_cols(statewide_df) %>%
  select(.pred,per_error) %>%
  mutate(resid = .pred - per_error) %>%
  filter(!is.na(resid))


results %>%
  ggplot(aes(.pred,per_error)) +
  geom_point() + 
  geom_abline(slope = 1) +
  labs(x = "Predicted Error in Estimation", y = "Actual Error in Estimation")


results %>% 
  ggplot() + 
  geom_histogram(aes(x = resid, y = ..density..),bins = 7) + 
  stat_function(fun = dnorm, 
                args = list(mean = mean(results$resid, na.rm = TRUE), sd = sd(results$resid, na.rm = TRUE)), 
                color = "red") +
  labs(x = "Predicted Error in Estimation", y = NULL)

results %>%
  ggplot(aes(x = .pred, y = resid)) + 
  geom_point() + 
  geom_abline(slope = 0) +
  labs(x = "Predicted Error in Estimation", y = "Residual")
```


<br>
<br>
<br>

